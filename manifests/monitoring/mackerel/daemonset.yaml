apiVersion: v1
kind: ServiceAccount
metadata:
  name: mackerel-container-agent
  namespace: mackerel
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: mackerel-container-agent
rules:
  - apiGroups:
      - ""
    resources:
      - nodes/proxy
      - nodes/stats
    verbs:
      - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: mackerel-container-agent
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: mackerel-container-agent
subjects:
  - kind: ServiceAccount
    name: mackerel-container-agent
    namespace: mackerel
---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: mackerel-container-agent
  namespace: mackerel
  labels:
    app: mackerel-container-agent
spec:
  selector:
    matchLabels:
      app: mackerel-container-agent
  template:
    metadata:
      labels:
        app: mackerel-container-agent
    spec:
      serviceAccountName: mackerel-container-agent
      containers:
        - name: mackerel-container-agent
          image: mackerel/mackerel-container-agent:latest
          imagePullPolicy: Always
          resources:
            limits:
              memory: 128Mi
            requests:
              memory: 64Mi
              cpu: 50m
          env:
            - name: MACKEREL_CONTAINER_PLATFORM
              value: kubernetes
            - name: MACKEREL_APIKEY
              valueFrom:
                secretKeyRef:
                  name: mackerel-apikey
                  key: apikey
            - name: MACKEREL_KUBERNETES_KUBELET_HOST
              valueFrom:
                fieldRef:
                  fieldPath: status.hostIP
            - name: MACKEREL_KUBERNETES_NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: MACKEREL_KUBERNETES_POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
            # kubeletのread-only portを無効化してデフォルトポートを使用
            - name: MACKEREL_KUBERNETES_KUBELET_READ_ONLY_PORT
              value: "0"
            # TLS証明書の検証をスキップ（self-signed cert対応）
            - name: MACKEREL_KUBERNETES_KUBELET_INSECURE_TLS
              value: "true"
